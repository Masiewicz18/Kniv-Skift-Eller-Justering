<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Digital Følgeseddel – Stanseværktøj</title>

  <style>
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Segoe UI,Arial,Helvetica,sans-serif;
      background:#f5f7fb;
      color:#0f172a;
    }
    :focus{outline:2px solid #94c5ff;outline-offset:1px}

    .topbar{background:#0a61ae;color:#fff;padding:8px 12px}
    .toprow{display:flex;align-items:center}
    .brand{font-weight:800;letter-spacing:.2px}
    .statuspill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid rgba(255,255,255,.35);
      border-radius:999px;padding:4px 12px;margin-left:10px;
      background:rgba(255,255,255,.08);font-size:12px;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:#17833e}
    .dot.pending{background:#f59e0b}
    .dot.error{background:#dc2626}

    .container{max-width:900px;margin:0 auto;padding:12px}
    .card{
      background:#fff;border:1px solid #e6ecf3;border-radius:12px;
      padding:14px;box-shadow:0 6px 20px rgba(15,23,42,.06);margin-bottom:12px;
    }
    h3{margin:0 0 8px}
    label{font-size:11px;color:#6b7280;display:block;margin-bottom:3px}

    input,textarea{
      width:100%;border:1px solid #dfe7f2;border-radius:10px;
      padding:7px 9px;background:#fff;font-size:14px;line-height:1.2;
    }
    textarea{min-height:70px}

    .hint{font-size:12px;color:#6b7280;margin-bottom:10px}

    .row{display:flex;flex-wrap:wrap;margin-left:-4px;margin-right:-4px}
    .field{flex:1 1 220px;padding-left:4px;padding-right:4px;margin-bottom:8px}
    .field.small{flex:0 0 200px}
    .field.full{flex:1 1 100%}

    .section-title{font-size:13px;font-weight:600;margin:10px 0 6px;color:#111827}

    .checkbox-row{display:flex;align-items:center;font-size:13px;margin-top:4px}
    .checkbox-row input{width:auto;margin-right:6px}

    .btn{
      border:1px solid #dbe4ef;background:#fff;border-radius:10px;
      padding:8px 12px;font-weight:700;cursor:pointer;font-size:14px;
    }
    .btn-primary{background:#e8f1ff;border-color:#cfe2ff;color:#0a3d91}
    .btn-danger{background:#fff1f1;border-color:#f3b3b3;color:#7f1d1d}
    .buttons{text-align:right;margin-top:8px}
    .buttons .btn{margin-left:6px}

    /* Historik */
    .loglist{
      list-style:none;margin:0;padding:0;border:1px dashed #dbe4ef;
      border-radius:10px;background:#fff;max-height:420px;overflow:auto;
    }
    .logitem{padding:10px;border-bottom:1px solid #eef2f7}
    .logitem:last-child{border-bottom:0}

    .log-header{display:flex;flex-wrap:wrap}
    .log-main{font-size:13px}
    .log-meta{text-align:right;font-size:12px;margin-left:auto;color:#6b7280}

    .badge{
      display:inline-block;border-radius:999px;padding:2px 8px;font-size:11px;
      border:1px solid #e2e8f0;background:#f8fafc;margin-right:6px;
    }
    .badge-tool{background:#e0f2fe;border-color:#bae6fd;color:#075985}
    .badge-adj{background:#ede9fe;border-color:#ddd6fe;color:#4c1d95}
    .badge-knife{background:#dcfce7;border-color:#bbf7d0;color:#166534}

    .editbox{
      margin-top:10px;padding:10px;background:#f8fbff;
      border:1px dashed #cfe2ff;border-radius:10px;display:none;
    }

    .resetconfirm{
      display:none;margin-top:10px;padding:10px;border:1px solid #fecaca;
      background:#fff1f2;border-radius:10px;font-size:13px;
    }

    .input-error{border-color:#dc2626;background:#fef2f2}
    .err-msg{font-size:11px;color:#b91c1c;min-height:14px}
  </style>
</head>

<body>

  <div class="topbar">
    <div class="toprow">
      <div class="brand">Digital Følgeseddel – Stanseværktøj</div>
      <span class="statuspill">
        <span id="dot" class="dot"></span>
        <span id="statxt">Online</span>
      </span>
    </div>
  </div>

  <div class="container">

    <!-- FORMULAR -->
    <div class="card">
      <h3>Ny registrering</h3>

      <div class="hint">
        <b>Følgeseddel – Stanseværktøj</b><br>
        Den digitale blankette bruges til at registrere indstillinger ved justering eller knivskift. Registreringerne skal gør det muligt løbende at forudsige, hvornår der bør skiftes knive før en produktion eller omstilling. Udfyld blanketten hver gang. Dato for knivskift udfyldes kun ved et reelt skift..<br><br>

        <b>Aktuel værdi</b> og <b>Justeret af</b> udfyldes kun ved indkøring eller justering i produktion (og efter knivskift hvis der justeres).<br>
        Knivskift kan ske før produktion, under indkøring, under produktion eller som forberedelse, fx hvis kvaliteten vurderes utilstrækkelig.
      </div>

      <form id="regForm" autocomplete="off">

        <div class="row">
          <div class="field small">
            <label>Værktøjsnr *</label>
            <input id="tool-no" type="text">
            <div id="err-tool" class="err-msg"></div>
          </div>

          <div class="field small">
            <label>Dato (registrering) *</label>
            <input id="reg-date" type="date">
            <div id="err-date" class="err-msg"></div>
          </div>
        </div>

        <div class="section-title">Denne registrering omfatter:</div>
        <div class="row">
          <div class="field small">
            <div class="checkbox-row">
              <input id="adj-active" type="checkbox"><label for="adj-active">Justeret / indkøring</label>
            </div>
          </div>
          <div class="field small">
            <div class="checkbox-row">
              <input id="knife-active" type="checkbox"><label for="knife-active">Knivskift udført</label>
            </div>
          </div>
        </div>

        <div class="section-title">Justering / indkøring</div>
        <div class="row">
          <div class="field small">
            <label>Ønsket værdi [mm]</label>
            <input id="desired" type="text">
            <div id="err-desired" class="err-msg"></div>
          </div>
          <div class="field small">
            <label>Aktuel værdi [mm]</label>
            <input id="actual" type="text">
            <div id="err-actual" class="err-msg"></div>
          </div>
          <div class="field small">
            <label>Justeret af</label>
            <input id="operator" type="text">
            <div id="err-operator" class="err-msg"></div>
          </div>
        </div>

        <div class="section-title">Knivskift</div>
        <div class="row">
          <div class="field small">
            <label>Dato for knivskift</label>
            <input id="knife-date" type="date">
          </div>
        </div>

        <div class="field full">
          <label>Bemærkninger</label>
          <textarea id="notes"></textarea>
        </div>

        <div class="buttons">
          <button type="button" class="btn" id="btn-clear">Ryd formular</button>
          <button type="submit" class="btn btn-primary">Gem registrering</button>
        </div>

        <div class="hint" id="hintText">
          Felter gemmes automatisk lokalt mens du skriver.
        </div>

      </form>
    </div>

    <!-- HISTORIK -->
    <div class="card">
      <h3>Historik</h3>
      <ul id="logList" class="loglist"></ul>

      <div class="buttons">
        <button id="btn-clear-log" class="btn btn-danger">Ryd lokal historik</button>
      </div>

      <div id="log-confirm" class="resetconfirm">
        <b>Er du sikker?</b>
        <div class="buttons">
          <button class="btn" id="btn-log-cancel">Fortryd</button>
          <button class="btn btn-danger" id="btn-log-do">Slet</button>
        </div>
      </div>

    </div>

  </div>

  <script>
/* ===========================
   HJÆLPEFUNKTIONER
   =========================== */
function $(id){return document.getElementById(id);}

function loadJSON(k,def){
  try{
    var v = localStorage.getItem(k);
    return v ? JSON.parse(v) : def;
  }catch(e){return def;}
}

function saveJSON(k,v){
  try{ localStorage.setItem(k,JSON.stringify(v)); }catch(e){}
}

function removeStorage(k){
  try{ localStorage.removeItem(k); }catch(e){}
}

function uuid(){
  return "id-" + Date.now() + "-" + Math.floor(Math.random()*1000000);
}

function todayIso(){
  var d = new Date();
  var m = "" + (d.getMonth()+1);
  var day = "" + d.getDate();
  var y = d.getFullYear();
  if(m.length<2){m="0"+m;}
  if(day.length<2){day="0"+day;}
  return y+"-"+m+"-"+day;
}

function fmtDate(d){
  if(!d)return "-";
  try{
    return new Date(d).toLocaleDateString("da-DK");
  }catch(e){return d;}
}

/* ===========================
   KEYS / NØGLER
   =========================== */
var PFX          = "ppstans.final.";
var KEY_DRAFT    = PFX + "draft.v1";
var KEY_LOG      = PFX + "history.v1";
var KEY_SETTINGS = PFX + "settings.v1";   // gemmer værktøjsnr
var KEY_EDIT     = PFX + "editdraft.v1";  // redigerings-udkast
var KEY_OPENEDIT = PFX + "openEdit.v1";   // sidst åbne editor-id

/* ===========================
   SIDST ÅBNE EDITOR
   =========================== */
function saveOpenEditor(id){
  saveJSON(KEY_OPENEDIT,id);
}
function loadOpenEditor(){
  return loadJSON(KEY_OPENEDIT,null);
}
function clearOpenEditor(){
  removeStorage(KEY_OPENEDIT);
}

/* ===========================
   AUTOSAVE – FORMULAR
   =========================== */
function saveDraft(){
  var d = {
    tool:   $("tool-no").value,
    reg:    $("reg-date").value,
    adj:    $("adj-active").checked,
    knife:  $("knife-active").checked,
    des:    $("desired").value,
    act:    $("actual").value,
    op:     $("operator").value,
    kdate:  $("knife-date").value,
    notes:  $("notes").value
  };
  saveJSON(KEY_DRAFT,d);

  // gem kun værktøjsnr i settings
  var s = loadJSON(KEY_SETTINGS,{});
  s.tool = d.tool || s.tool || "";
  saveJSON(KEY_SETTINGS,s);

  $("statxt").innerHTML = "Udkast gemt lokalt";
}

function restoreDraft(){
  var d = loadJSON(KEY_DRAFT,null);
  var s = loadJSON(KEY_SETTINGS,{});
  if(!d)d={};

  $("tool-no").value      = d.tool  || s.tool || "";
  $("reg-date").value     = d.reg   || todayIso();
  $("adj-active").checked = d.adj   ? true : false;
  $("knife-active").checked = d.knife ? true : false;
  $("desired").value      = d.des   || "";
  $("actual").value       = d.act   || "";
  $("operator").value     = d.op    || "";
  $("knife-date").value   = d.kdate || "";
  $("notes").value        = d.notes || "";
}

/* ===========================
   AUTOSAVE – REDIGERING
   =========================== */
function saveEditDraft(id,data){
  var all = loadJSON(KEY_EDIT,{});
  all[id] = data;
  saveJSON(KEY_EDIT,all);
}
function loadEditDraft(id){
  var all = loadJSON(KEY_EDIT,{});
  return all[id] || null;
}
function clearEditDraft(id){
  var all = loadJSON(KEY_EDIT,{});
  if(all[id]){ delete all[id]; }
  saveJSON(KEY_EDIT,all);
}

/* ===========================
   HISTORIK DATA
   =========================== */
function getLog(){return loadJSON(KEY_LOG,[]);}
function saveLog(a){saveJSON(KEY_LOG,a);}

/* ===========================
   VALIDERING
   =========================== */
function clearErrors(){
  var ids  = ["tool-no","reg-date","desired","actual","operator"];
  var msgs = ["err-tool","err-date","err-desired","err-actual","err-operator"];
  var i,f,m;

  for(i=0;i<ids.length;i++){
    f = $(ids[i]);
    if(f){ f.className = f.className.replace("input-error",""); }
  }
  for(i=0;i<msgs.length;i++){
    m = $(msgs[i]);
    if(m){ m.innerHTML=""; }
  }

  $("hintText").innerHTML = "Felter gemmes automatisk lokalt mens du skriver.";
  $("hintText").style.color = "#6b7280";
}

function validateForm(){
  clearErrors();
  var ok = true;

  var tool  = $("tool-no").value;
  var reg   = $("reg-date").value;
  var adj   = $("adj-active").checked;
  var knife = $("knife-active").checked;
  var des   = $("desired").value;
  var act   = $("actual").value;
  var op    = $("operator").value;

  if(!tool.replace(/\s+/g,"")){
    $("tool-no").className += " input-error";
    $("err-tool").innerHTML = "Udfyld værktøjsnr.";
    ok=false;
  }
  if(!reg){
    $("reg-date").className += " input-error";
    $("err-date").innerHTML = "Vælg dato.";
    ok=false;
  }

  if(!adj && !knife){
    $("hintText").innerHTML = "Vælg mindst Justering eller Knivskift.";
    $("hintText").style.color = "#b91c1c";
    ok=false;
  }

  if(adj){
    if(!des.replace(/\s+/g,"")){
      $("desired").className += " input-error";
      $("err-desired").innerHTML="Udfyld ønsket værdi.";
      ok=false;
    }
    if(!act.replace(/\s+/g,"")){
      $("actual").className += " input-error";
      $("err-actual").innerHTML="Udfyld aktuel værdi.";
      ok=false;
    }
    if(!op.replace(/\s+/g,"")){
      $("operator").className += " input-error";
      $("err-operator").innerHTML="Udfyld justeret af.";
      ok=false;
    }
  }

  return ok;
}

/* ===========================
   GEM NY REGISTRERING
   =========================== */
function submitForm(e){
  if(e && e.preventDefault){e.preventDefault();}
  if(!validateForm()) return;

  var tool  = $("tool-no").value;
  var reg   = $("reg-date").value;
  var adj   = $("adj-active").checked;
  var knife = $("knife-active").checked;
  var des   = $("desired").value;
  var act   = $("actual").value;
  var op    = $("operator").value;
  var kdate = $("knife-date").value;
  var notes = $("notes").value;

  if(knife && !kdate){
    kdate = reg || todayIso();
  }

  var entry = {
    id: uuid(),
    ts: new Date().toISOString(),
    toolNo: tool,
    regDate: reg,
    adjActive: adj,
    knifeActive: knife,
    desired: des,
    actual: act,
    operator: op,
    knifeDate: kdate,
    notes: notes
  };

  var arr = getLog();
  arr.push(entry);
  saveLog(arr);

  // kø til Power Automate (defineret i DEL 3)
  queueSend(entry);

  // ryd felter – behold kun værktøjsnr via settings
  $("reg-date").value = todayIso();
  $("adj-active").checked=false;
  $("knife-active").checked=false;
  $("desired").value="";
  $("actual").value="";
  $("operator").value="";
  $("knife-date").value="";
  $("notes").value="";

  // opdater draft (værktøjsnr gemmes)
  saveDraft();

  $("hintText").innerHTML="Registrering gemt. Sendes om ca. 3 minutter.";
  $("hintText").style.color="#16a34a";

  renderLog();
}

/* ===========================
   RYD FORMULAR
   =========================== */
function clearForm(){
  $("tool-no").value="";
  $("reg-date").value=todayIso();
  $("adj-active").checked=false;
  $("knife-active").checked=false;
  $("desired").value="";
  $("actual").value="";
  $("operator").value="";
  $("knife-date").value="";
  $("notes").value="";
  removeStorage(KEY_DRAFT);
  saveDraft();
  clearErrors();
}

/* ===========================
   REDIGERING – HJÆLP
   =========================== */
function collectEditDraft(id){
  return {
    desired: $("e-desired-"+id).value,
    actual:  $("e-actual-"+id).value,
    operator:$("e-operator-"+id).value,
    notes:   $("e-notes-"+id).value,
    kdate:   $("e-kdate-"+id).value
  };
}

function saveEditEntry(id){
  var arr = getLog();
  var i, r=null;
  for(i=0;i<arr.length;i++){
    if(arr[i].id===id){ r=arr[i]; break; }
  }
  if(!r) return;

  r.desired   = $("e-desired-"+id).value;
  r.actual    = $("e-actual-"+id).value;
  r.operator  = $("e-operator-"+id).value;
  r.notes     = $("e-notes-"+id).value;
  r.knifeDate = $("e-kdate-"+id).value;

  saveLog(arr);

  // opdatér køen hvis denne endnu ikke er sendt (defineret i DEL 3)
  updateQueueForEntry(r);
}

/* ===========================
   ÅBN REDIGERINGSBOKS
   =========================== */
function openEdit(id){
  var box = $("edit-"+id);
  if(!box)return;

  box.style.display="block";
  saveOpenEditor(id);

  var arr = getLog();
  var i, r=null;
  for(i=0;i<arr.length;i++){
    if(arr[i].id===id){ r=arr[i]; break; }
  }

  var desEl = $("e-desired-"+id);
  var actEl = $("e-actual-"+id);
  var opEl  = $("e-operator-"+id);
  var kdEl  = $("e-kdate-"+id);
  var ntEl  = $("e-notes-"+id);

  var draft = loadEditDraft(id);
  if(draft){
    desEl.value = draft.desired || "";
    actEl.value = draft.actual  || "";
    opEl.value  = draft.operator|| "";
    kdEl.value  = draft.kdate   || "";
    ntEl.value  = draft.notes   || "";
  }else if(r){
    desEl.value = r.desired  || "";
    actEl.value = r.actual   || "";
    opEl.value  = r.operator || "";
    kdEl.value  = r.knifeDate|| "";
    ntEl.value  = r.notes    || "";
  }

  desEl.oninput = function(){ saveEditDraft(id,collectEditDraft(id)); };
  actEl.oninput = function(){ saveEditDraft(id,collectEditDraft(id)); };
  opEl.oninput  = function(){ saveEditDraft(id,collectEditDraft(id)); };
  ntEl.oninput  = function(){ saveEditDraft(id,collectEditDraft(id)); };
  kdEl.onchange = function(){ saveEditDraft(id,collectEditDraft(id)); };

  $("e-cancel-"+id).onclick=function(){
    clearEditDraft(id);
    clearOpenEditor();
    box.style.display="none";
  };

  $("e-save-"+id).onclick=function(){
    saveEditEntry(id);
    clearEditDraft(id);
    clearOpenEditor();
    box.style.display="none";
    renderLog();
  };
}

/* ===========================
   RENDER HISTORIK
   =========================== */
function renderLog(){
  var list = $("logList");
  list.innerHTML="";

  var arr = getLog().slice();
  arr.sort(function(a,b){
    return (b.regDate + b.ts).localeCompare(a.regDate + a.ts);
  });

  if(arr.length===0){
    var liEmpty=document.createElement("li");
    liEmpty.className="logitem";
    liEmpty.innerHTML='<span class="hint">Ingen registreringer endnu.</span>';
    list.appendChild(liEmpty);
    return;
  }

  var i;
  for(i=0;i<arr.length;i++){
    var r=arr[i];
    var li=document.createElement("li");
    li.className="logitem";

    var head=document.createElement("div");
    head.className="log-header";

    var main=document.createElement("div");
    main.className="log-main";

    var badges='<span class="badge badge-tool">'+r.toolNo+'</span>';
    if(r.adjActive){badges+='<span class="badge badge-adj">Justeret</span>';}
    if(r.knifeActive){badges+='<span class="badge badge-knife">Knivskift</span>';}

    var tParts=[];
    tParts.push("Registreret: "+fmtDate(r.regDate));
    if(r.desired){tParts.push("Ønsket: "+r.desired);}
    if(r.actual){tParts.push("Aktuel: "+r.actual);}

    main.innerHTML = badges + '<div>'+tParts.join(" · ")+'</div>';

    var meta=document.createElement("div");
    meta.className="log-meta";
    var m=[];
    if(r.operator){m.push("Justeret af: "+r.operator);}
    if(r.knifeDate){m.push("Knivskift: "+fmtDate(r.knifeDate));}
    m.push("Oprettet: "+fmtDate(r.ts));
    meta.innerHTML=m.join("<br>");

    head.appendChild(main);
    head.appendChild(meta);
    li.appendChild(head);

    if(r.notes){
      var nd=document.createElement("div");
      nd.style.fontSize="12px";
      nd.style.marginTop="4px";
      nd.innerHTML="Noter: "+r.notes;
      li.appendChild(nd);
    }

    var ed=document.createElement("div");
    ed.className="editbox";
    ed.id="edit-"+r.id;
    ed.innerHTML =
      '<div class="row">'+
        '<div class="field small"><label>Ønsket værdi</label>'+
          '<input id="e-desired-'+r.id+'" type="text"></div>'+
        '<div class="field small"><label>Aktuel værdi</label>'+
          '<input id="e-actual-'+r.id+'" type="text"></div>'+
        '<div class="field small"><label>Justeret af</label>'+
          '<input id="e-operator-'+r.id+'" type="text"></div>'+
      '</div>'+
      '<div class="row">'+
        '<div class="field small"><label>Dato knivskift</label>'+
          '<input id="e-kdate-'+r.id+'" type="date"></div>'+
      '</div>'+
      '<div class="field full"><label>Noter</label>'+
        '<textarea id="e-notes-'+r.id+'"></textarea></div>'+
      '<div class="buttons">'+
        '<button class="btn" id="e-cancel-'+r.id+'">Annuller</button>'+
        '<button class="btn btn-primary" id="e-save-'+r.id+'">Gem ændringer</button>'+
      '</div>';
    li.appendChild(ed);

    var btn=document.createElement("button");
    btn.className="btn";
    btn.style.marginTop="8px";
    btn.innerHTML="Redigér";
    btn.onclick=(function(id){
      return function(){openEdit(id);};
    })(r.id);
    li.appendChild(btn);

    list.appendChild(li);
  }

  // Genåbn sidst åbne editor (MODE A)
  var last = loadOpenEditor();
  if(last){
    setTimeout(function(){openEdit(last);},50);
  }
}
/* ===========================
   POWER AUTOMATE – 3 MIN KØ
   =========================== */

// Sæt din nye Power Automate URL her, når du har den:
var ENDPOINT = "https://default430cd76f558540b4b6d4f372acf579.16.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/e06284babf144aa3a952eafbac61cc3d/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=FxgdFtDNA7UhjaZ0CJ6nCk87Q_BZM6gQVQX3EKkfpAY";

var FEED_KEY = PFX + "feedqueue.v1";
var DELAY_MS = 3 * 60 * 1000; // 3 minutter

function queueSend(entry){
  // hvis der ikke er endpoint endnu, køer vi stadig lokalt
  var feed = loadJSON(FEED_KEY,[]);
  feed.push({
    ts: new Date().toISOString(),
    notBefore: new Date(Date.now()+DELAY_MS).toISOString(),
    payload: entry,
    sent: false
  });
  saveJSON(FEED_KEY,feed);
  updateStatusLamp();
}

function sendToPowerAutomate(payload,cb){
  if(!ENDPOINT || ENDPOINT.indexOf("http")!==0){
    if(cb)cb(false);
    return;
  }
  try{
    var x = new XMLHttpRequest();
    x.open("POST",ENDPOINT,true);
    x.setRequestHeader("Content-Type","application/json;charset=UTF-8");
    x.timeout=15000;
    x.onerror=function(){ if(cb)cb(false); };
    x.ontimeout=function(){ if(cb)cb(false); };
    x.onreadystatechange=function(){
      if(x.readyState===4){
        var ok=(x.status>=200 && x.status<300);
        if(cb)cb(ok);
      }
    };
    x.send(JSON.stringify(payload));
  }catch(e){
    if(cb)cb(false);
  }
}

function flushQueue(){
  var feed = loadJSON(FEED_KEY,[]);
  var now = Date.now();
  var i;
  for(i=0;i<feed.length;i++){
    var item = feed[i];
    if(item.sent) continue;
    var nb = new Date(item.notBefore).getTime();
    if(nb>now) continue;

    (function(index){
      sendToPowerAutomate(feed[index].payload,function(ok){
        if(ok){
          var f2 = loadJSON(FEED_KEY,[]);
          if(f2[index]){
            f2[index].sent=true;
            saveJSON(FEED_KEY,f2);
          }
        }
        updateStatusLamp();
      });
    })(i);
  }
  updateStatusLamp();
}

function unsentCount(){
  var f = loadJSON(FEED_KEY,[]);
  var c=0,i;
  for(i=0;i<f.length;i++){
    if(!f[i].sent)c++;
  }
  return c;
}

function updateStatusLamp(){
  var dot = $("dot");
  var txt = $("statxt");
  var n = unsentCount();
  if(n===0){
    dot.className="dot";
    txt.innerHTML="Online";
  }else{
    dot.className="dot pending";
    txt.innerHTML="Afventer afsendelse ("+n+")";
  }
}

/* Opdater kø-payload hvis der redigeres inden afsendelse */
function updateQueueForEntry(entry){
  var feed = loadJSON(FEED_KEY,[]);
  var changed=false;
  var i;
  for(i=0;i<feed.length;i++){
    if(!feed[i].sent && feed[i].payload && feed[i].payload.id===entry.id){
      feed[i].payload = entry;
      changed=true;
    }
  }
  if(changed){
    saveJSON(FEED_KEY,feed);
    updateStatusLamp();
  }
}

/* ===========================
   BIND EVENTS
   =========================== */
function bind(){
  var ids=["tool-no","reg-date","desired","actual","operator","knife-date","notes"];
  var i;
  for(i=0;i<ids.length;i++){
    (function(id){
      var el=$(id);
      if(!el)return;
      el.oninput=saveDraft;
      el.onchange=saveDraft;
    })(ids[i]);
  }

  $("adj-active").onchange=saveDraft;
  $("knife-active").onchange=function(){
    if(this.checked && !$("knife-date").value){
      $("knife-date").value = $("reg-date").value || todayIso();
    }
    saveDraft();
  };

  $("regForm").onsubmit=submitForm;
  $("btn-clear").onclick=clearForm;

  $("btn-clear-log").onclick=function(){
    var box=$("log-confirm");
    box.style.display=(box.style.display==="block"?"none":"block");
  };
  $("btn-log-cancel").onclick=function(){
    $("log-confirm").style.display="none";
  };
  $("btn-log-do").onclick=function(){
    saveLog([]);
    removeStorage(KEY_EDIT);
    clearOpenEditor();
    $("log-confirm").style.display="none";
    renderLog();
  };
}

/* ===========================
   INIT
   =========================== */
window.addEventListener("DOMContentLoaded",function(){
  restoreDraft();
  if(!$("reg-date").value){
    $("reg-date").value=todayIso();
  }

  renderLog();
  bind();
  updateStatusLamp();
  flushQueue();
  setInterval(flushQueue,30000); // prøv at sende hver 30. sekund
});
  </script>

</body>
</html>

